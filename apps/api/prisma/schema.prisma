// SiteFlow Prisma Schema
// Synchronized with database migrations (001_init_part1.sql + 001_init_part2.sql)

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ════════════════════════════════════════════════════════════════════════════
// ENUMS
// ════════════════════════════════════════════════════════════════════════════

enum ProjectRole {
  INVESTOR
  INSPECTOR
  GC
  SUB
  PROCUREMENT
}

enum TaskStatus {
  NEW
  PLANNED
  IN_PROGRESS
  READY_FOR_REVIEW
  DONE
  CANCELLED
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
}

enum IssueStatus {
  OPEN
  ASSIGNED
  FIXED
  VERIFIED
  CLOSED
}

enum DeliveryStatus {
  REQUESTED
  ORDERED
  IN_TRANSIT
  DELIVERED
  ACCEPTED
  REJECTED
}

enum DecisionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum EntityType {
  TASK
  INSPECTION
  ISSUE
  DELIVERY
  DECISION
  LOCATION
  COMMENT
  FILE
  PROJECT
}

enum ChecklistItemType {
  BOOL
  TEXT
  NUMBER
  SELECT
  PHOTO
}

enum NotificationChannel {
  IN_APP
  EMAIL
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
  CANCELED
}

enum OutboxStatus {
  NEW
  PROCESSING
  DONE
  FAILED
}

enum MembershipStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ════════════════════════════════════════════════════════════════════════════
// INSTANCE & TENANTS (Tables 1-2)
// ════════════════════════════════════════════════════════════════════════════

model InstanceSettings {
  id               Int      @id @default(1)
  publicJson       Json     @map("public_json")
  secretsEncrypted Bytes    @map("secrets_encrypted")
  secretsKeyId     String   @map("secrets_key_id")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("instance_settings")
}

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  users               User[]
  tenantRoles         TenantRole[]
  projects            Project[]
  tags                Tag[]
  checklistTemplates  ChecklistTemplate[]

  @@map("tenants")
}

// ════════════════════════════════════════════════════════════════════════════
// USERS & AUTH (Tables 3-12)
// ════════════════════════════════════════════════════════════════════════════

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  email        String
  name         String
  passwordHash String    @map("password_hash")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  tenant              Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantRoles         UserTenantRole[]
  projectMemberships  ProjectMember[]
  refreshTokens       RefreshToken[]
  createdProjects     Project[]                  @relation("ProjectCreatedBy")
  updatedProjects     Project[]                  @relation("ProjectUpdatedBy")
  createdLocations    Location[]                 @relation("LocationCreatedBy")
  updatedLocations    Location[]                 @relation("LocationUpdatedBy")
  createdTasks        Task[]                     @relation("TaskCreatedBy")
  updatedTasks        Task[]                     @relation("TaskUpdatedBy")
  taskAssignments     TaskAssignee[]
  taskWatchers        TaskWatcher[]
  createdInspections  Inspection[]               @relation("InspectionCreatedBy")
  updatedInspections  Inspection[]               @relation("InspectionUpdatedBy")
  createdIssues       Issue[]                    @relation("IssueCreatedBy")
  updatedIssues       Issue[]                    @relation("IssueUpdatedBy")
  assignedIssues      Issue[]                    @relation("IssueAssignee")
  createdDeliveries   Delivery[]                 @relation("DeliveryCreatedBy")
  updatedDeliveries   Delivery[]                 @relation("DeliveryUpdatedBy")
  createdDecisions    Decision[]                 @relation("DecisionCreatedBy")
  updatedDecisions    Decision[]                 @relation("DecisionUpdatedBy")
  ownedDecisions      Decision[]                 @relation("DecisionOwner")
  decisionApprovals   DecisionApproval[]
  uploadedFiles       File[]
  createdComments     Comment[]                  @relation("CommentCreatedBy")
  updatedComments     Comment[]                  @relation("CommentUpdatedBy")
  notifications       Notification[]
  notificationSettings UserNotificationSettings?

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String

  tenantRolePermissions  TenantRolePermission[]
  projectRolePermissions ProjectRolePermission[]

  @@map("permissions")
}

model TenantRole {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  name        String
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions  TenantRolePermission[]
  userRoles    UserTenantRole[]

  @@unique([tenantId, name])
  @@map("tenant_roles")
}

model TenantRolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       TenantRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("tenant_role_permissions")
}

model UserTenantRole {
  userId     String   @map("user_id") @db.Uuid
  roleId     String   @map("role_id") @db.Uuid
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role TenantRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_tenant_roles")
}

model Invite {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String        @map("tenant_id") @db.Uuid
  email      String
  roleId     String        @map("role_id") @db.Uuid
  tokenHash  String        @map("token_hash")
  status     InviteStatus  @default(PENDING)
  expiresAt  DateTime      @map("expires_at")
  acceptedAt DateTime?     @map("accepted_at")
  revokedAt  DateTime?     @map("revoked_at")
  createdBy  String        @map("created_by") @db.Uuid
  createdAt  DateTime      @default(now()) @map("created_at")

  @@unique([tenantId, email])
  @@index([tokenHash])
  @@index([status])
  @@map("invites")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([revokedAt])
  @@map("refresh_tokens")
}

model PasswordReset {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  tokenHash String    @map("token_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([tokenHash])
  @@map("password_resets")
}

model LoginAttempt {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String
  ipAddress   String   @map("ip_address")
  userAgent   String?  @map("user_agent")
  success     Boolean
  attemptedAt DateTime @default(now()) @map("attempted_at")

  @@index([email, attemptedAt])
  @@map("login_attempts")
}

// ════════════════════════════════════════════════════════════════════════════
// PROJECTS & LOCATIONS (Tables 13-16)
// ════════════════════════════════════════════════════════════════════════════

model Project {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  name        String
  code        String
  description String?
  startDate   DateTime? @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  createdBy   String    @map("created_by") @db.Uuid
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  updatedBy   String    @map("updated_by") @db.Uuid
  deletedAt   DateTime? @map("deleted_at")

  tenant              Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator             User                    @relation("ProjectCreatedBy", fields: [createdBy], references: [id])
  updater             User                    @relation("ProjectUpdatedBy", fields: [updatedBy], references: [id])
  members             ProjectMember[]
  locations           Location[]
  tasks               Task[]
  checklistRuns       ChecklistRun[]
  inspections         Inspection[]
  issues              Issue[]
  deliveries          Delivery[]
  decisions           Decision[]
  files               File[]
  comments            Comment[]
  activityLogs        ActivityLog[]
  notifications       Notification[]
  automationRules     AutomationRule[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([deletedAt])
  @@map("projects")
}

model ProjectMember {
  projectId String      @map("project_id") @db.Uuid
  userId    String      @map("user_id") @db.Uuid
  role      ProjectRole
  joinedAt  DateTime    @default(now()) @map("joined_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([projectId, userId])
  @@index([userId])
  @@map("project_members")
}

model ProjectRolePermission {
  role         ProjectRole @map("role")
  permissionId String      @map("permission_id") @db.Uuid

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([role, permissionId])
  @@map("project_role_permissions")
}

model Location {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String    @map("project_id") @db.Uuid
  parentId  String?   @map("parent_id") @db.Uuid
  name      String
  path      String
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String    @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  updatedBy String    @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at")

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent      Location?    @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    Location[]   @relation("LocationHierarchy")
  creator     User         @relation("LocationCreatedBy", fields: [createdBy], references: [id])
  updater     User         @relation("LocationUpdatedBy", fields: [updatedBy], references: [id])
  tasks       Task[]
  inspections Inspection[]
  issues      Issue[]
  deliveries  Delivery[]

  @@unique([projectId, path])
  @@index([projectId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("locations")
}

// Continue with remaining tables in next part...
// Due to size limits, I'll split the schema into multiple pushes
